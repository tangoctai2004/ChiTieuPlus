import SwiftUI
import CoreData

// MARK: - ContentView (ƒê√£ s·ª≠a)
struct TaoDuLieuMau: View {
    @Environment(\.managedObjectContext) private var context
    
    // State cho TabBar (Gi·ªØ nguy√™n)
    @State private var tabSelection: Int = 1
    @Namespace private var animation
    
    // ViewModel cho m√†n h√¨nh Add (Gi·ªØ nguy√™n)
    @StateObject private var transactionFormViewModel = TransactionFormViewModel()
    
    // --- D·ªØ li·ªáu m·∫´u cho Category (Gi·ªØ nguy√™n) ---
    // *** L∆∞u √Ω: Ch√∫ng ta s·∫Ω d√πng KEY ƒë·ªÉ l∆∞u v√†o DB ***
    let defaultExpenses: [(nameKey: String, iconName: String)] = [ // ƒê·ªïi 'name' th√†nh 'nameKey'
        ("default_category_food", "fork.knife"),
        ("default_category_daily_spending", "cart.fill"),
        ("default_category_clothing", "tshirt.fill"),
        ("default_category_cosmetics", "hand.raised.fingers.spread.fill"),
        ("default_category_party", "party.popper.fill"),
        ("default_category_medical", "pills.fill"),
        ("default_category_education", "graduationcap.fill"),
        ("default_category_electricity", "bolt.fill"),
        ("default_category_transport", "bus.fill"),
        ("default_category_communication", "phone.fill"),
        ("default_category_housing", "house.fill")
    ]
    
    let defaultIncomes: [(nameKey: String, iconName: String)] = [ // ƒê·ªïi 'name' th√†nh 'nameKey'
        ("default_category_salary", "banknote.fill"),
        ("default_category_allowance", "person.3.fill"),
        ("default_category_bonus", "dollarsign.circle.fill"),
        ("default_category_side_income", "lightbulb.fill"),
        ("default_category_investment", "chart.line.uptrend.xyaxis"),
        ("default_category_temporary_income", "briefcase.fill")
    ]
    
    init() {
        UITabBar.appearance().isHidden = true
    }
    
    private let tabBarHeight: CGFloat = 80

    // --- GIAO DI·ªÜN CH√çNH C·ª¶A APP ---
    var body: some View {
        ZStack(alignment: .bottom) {
            // N·ªôi dung ch√≠nh theo tab
            Group {
                switch tabSelection {
                case 1:
                    HomeScreen()
                        .padding(.bottom, tabBarHeight)
                case 2:
                    // --- S·ª¨A ƒê·ªîI: Chuy·ªÉn CategoryListScreen sang tab 2 ---
                    CategoryListScreen()
                        .padding(.bottom, tabBarHeight)
                    // --- K·∫æT TH√öC S·ª¨A ƒê·ªîI ---
                case 3:
                    TransactionAddScreen()
                        .padding(.bottom, tabBarHeight)
                case 4:
                    DashboardScreen()
                        .padding(.bottom, tabBarHeight)
                case 5:
                    SettingScreen()
                        .padding(.bottom, tabBarHeight)
                default:
                    HomeScreen()
                        .padding(.bottom, tabBarHeight)
                }
            }
            .frame(maxWidth: .infinity, maxHeight: .infinity)
            .background(Color(.systemGroupedBackground))
            .environmentObject(transactionFormViewModel) // Truy·ªÅn ViewModel v√†o m√¥i tr∆∞·ªùng
            
            // TabBar t√πy ch·ªânh
            CustomTabBar(tabSelection: $tabSelection, animation: animation)
        }
        .ignoresSafeArea(.container, edges: .bottom)
        .ignoresSafeArea(.keyboard, edges: .bottom)
        .onAppear {
            // --- G·ªåI H√ÄM SEED ·ªû ƒê√ÇY ---
            // Ch·∫°y c√°c h√†m seed khi View ch√≠nh xu·∫•t hi·ªán l·∫ßn ƒë·∫ßu
            // C√°c h√†m n√†y s·∫Ω t·ª± ki·ªÉm tra ƒë·ªÉ kh√¥ng ch·∫°y l·∫°i n·∫øu d·ªØ li·ªáu ƒë√£ t·ªìn t·∫°i
            
            // 1. T·∫°o Category tr∆∞·ªõc (l∆∞u KEY)
            seedDefaultCategoriesIfNeeded(context: context)
            
            // 2. T·∫°o Transaction (s·∫Ω d√πng Category ·ªü b∆∞·ªõc 1)
            seedSampleTransactionsIfNeeded(context: context)
            // --- K·∫æT TH√öC G·ªåI H√ÄM SEED ---
        }
    }

    // --- H√ÄM SEED CATEGORY (ƒê√£ s·ª≠a ƒë·ªÉ l∆∞u KEY) ---
    func seedDefaultCategoriesIfNeeded(context: NSManagedObjectContext) {
        let fetchRequest: NSFetchRequest<Category> = Category.fetchRequest()
        
        do {
            let existingCount = try context.count(for: fetchRequest)
            guard existingCount == 0 else {
                // print("‚úÖ D·ªØ li·ªáu Category ƒë√£ t·ªìn t·∫°i, kh√¥ng c·∫ßn seed.") // B·ªè comment n·∫øu mu·ªën th·∫•y log
                return
            }
        } catch {
            print("‚ùå L·ªói khi ki·ªÉm tra Category: \(error)")
            return
        }

        print("üîÑ B·∫Øt ƒë·∫ßu seed d·ªØ li·ªáu Category (l∆∞u key)...")
        // L∆∞u 'nameKey' (kh√≥a) tr·ª±c ti·∫øp v√†o database
        for categoryInfo in defaultExpenses {
            let cat = Category(context: context)
            cat.id = UUID()
            cat.name = categoryInfo.nameKey // <-- L∆ØU KEY
            cat.type = "expense"
            cat.iconName = categoryInfo.iconName
            cat.createAt = Date()
            cat.updateAt = Date()
        }

        for categoryInfo in defaultIncomes {
            let cat = Category(context: context)
            cat.id = UUID()
            cat.name = categoryInfo.nameKey // <-- L∆ØU KEY
            cat.type = "income"
            cat.iconName = categoryInfo.iconName
            cat.createAt = Date()
            cat.updateAt = Date()
        }

        do {
            try context.save()
            print("‚úÖ ƒê√£ seed th√†nh c√¥ng c√°c category m·∫∑c ƒë·ªãnh (ƒë√£ l∆∞u key).")
        } catch {
            print("‚ùå L·ªói khi l∆∞u c√°c category m·∫∑c ƒë·ªãnh: \(error)")
        }
    }

    // --- H√ÄM SEED TRANSACTION (ƒê√£ s·ª≠a ƒë·ªÉ d√πng KEY khi l·∫•y Category) ---
    func seedSampleTransactionsIfNeeded(context: NSManagedObjectContext) {
        let transactionFetchRequest: NSFetchRequest<Transaction> = Transaction.fetchRequest()
        
        do {
            let existingCount = try context.count(for: transactionFetchRequest)
            guard existingCount == 0 else {
                // print("‚úÖ D·ªØ li·ªáu Transaction ƒë√£ t·ªìn t·∫°i, kh√¥ng c·∫ßn seed.") // B·ªè comment n·∫øu mu·ªën th·∫•y log
                return
            }
        } catch {
            print("‚ùå L·ªói khi ki·ªÉm tra Transaction: \(error)")
            return
        }

        // 1. L·∫•y t·∫•t c·∫£ c√°c Category ƒë√£ t·∫°o (ch·ª©a KEY trong 'name')
        let categoryFetchRequest: NSFetchRequest<Category> = Category.fetchRequest()
        guard let allCategories = try? context.fetch(categoryFetchRequest), !allCategories.isEmpty else {
            print("‚ùå Kh√¥ng t√¨m th·∫•y Category ƒë·ªÉ t·∫°o Transaction. H√£y ƒë·∫£m b·∫£o seed Category tr∆∞·ªõc.")
            return
        }
        
        let expenseCategories = allCategories.filter { $0.type == "expense" }
        let incomeCategories = allCategories.filter { $0.type == "income" }
        
        guard !expenseCategories.isEmpty, !incomeCategories.isEmpty else {
            print("‚ùå Thi·∫øu danh m·ª•c thu nh·∫≠p ho·∫∑c chi ti√™u.")
            return
        }
        
        // --- S·ª¨A ƒê·ªîI: T√¨m category 'Ti·ªÅn l∆∞∆°ng' b·∫±ng KEY ---
        let salaryCategory = incomeCategories.first { $0.name == "default_category_salary" }
        // --- K·∫æT TH√öC S·ª¨A ƒê·ªîI ---

        let calendar = Calendar.current
        let endDate = Date() // Ng√†y h√¥m nay
        guard let startDate = calendar.date(byAdding: .year, value: -3, to: endDate) else {
            print("‚ùå Kh√¥ng th·ªÉ t√≠nh to√°n ng√†y b·∫Øt ƒë·∫ßu.")
            return
        }

        var currentDate = startDate
        // --- S·ª¨A ƒê·ªîI: D√πng key cho sample titles/notes n·∫øu mu·ªën ---
        // Ho·∫∑c gi·ªØ nguy√™n Ti·∫øng Vi·ªát c≈©ng kh√¥ng sao v√¨ ƒë√¢y l√† d·ªØ li·ªáu m·∫´u
        let sampleNotes = ["C√† ph√™ v·ªõi b·∫°n", "ƒÇn tr∆∞a vƒÉn ph√≤ng", "Mua s·∫Øm Shopee", "Thanh to√°n ho√° ƒë∆°n ƒëi·ªán", "Xem phim cu·ªëi tu·∫ßn", "ƒê·ªï xƒÉng", "ƒêi si√™u th·ªã"]
        let sampleTitles = ["default_category_food", "default_category_transport", "default_category_daily_spending", "default_category_clothing"] // V√≠ d·ª• d√πng key

        print("üîÑ B·∫Øt ƒë·∫ßu seed d·ªØ li·ªáu giao d·ªãch 3 nƒÉm...")

        // 2. L·∫∑p qua t·ª´ng th√°ng trong 3 nƒÉm
        while currentDate <= endDate {
            let currentMonth = calendar.component(.month, from: currentDate)
            let currentYear = calendar.component(.year, from: currentDate)
            
            // --- T·∫°o 1-3 giao d·ªãch THU NH·∫¨P m·ªói th√°ng ---
            let incomeCount = Int.random(in: 1...3)
            for i in 0..<incomeCount {
                guard let randomCategory = incomeCategories.randomElement() else { continue }
                
                // --- S·ª¨A ƒê·ªîI: Ki·ªÉm tra category 'Ti·ªÅn l∆∞∆°ng' b·∫±ng KEY ---
                let isSalary = (randomCategory.name == "default_category_salary" && i == 0)
                let randomDay = isSalary ? 5 : Int.random(in: 1...28) // Gi·∫£ l·∫≠p ng√†y nh·∫≠n l∆∞∆°ng
                // --- K·∫æT TH√öC S·ª¨A ƒê·ªîI ---
                
                guard let transactionDate = calendar.date(from: DateComponents(year: currentYear, month: currentMonth, day: randomDay)) else { continue }
                
                let amount: Double
                if isSalary {
                    amount = Double.random(in: 15_000_000...30_000_000) // L∆∞∆°ng cao h∆°n
                } else {
                    amount = Double.random(in: 500_000...3_000_000) // Thu nh·∫≠p ph·ª•
                }

                createTransaction(
                    context: context,
                    category: randomCategory,
                    date: transactionDate,
                    amount: amount,
                    // --- S·ª¨A ƒê·ªîI: D√πng key l√†m title (s·∫Ω ƒë∆∞·ª£c d·ªãch khi hi·ªÉn th·ªã) ---
                    title: randomCategory.name ?? "common_income", // D√πng key c·ªßa category
                    // --- K·∫æT TH√öC S·ª¨A ƒê·ªîI ---
                    note: "Thu nh·∫≠p th√°ng \(currentMonth)" // Gi·ªØ nguy√™n ho·∫∑c d√πng key
                )
            }
            
            // --- T·∫°o 15-30 giao d·ªãch CHI TI√äU m·ªói th√°ng ---
            let expenseCount = Int.random(in: 15...30)
            for _ in 0..<expenseCount {
                guard let randomCategory = expenseCategories.randomElement() else { continue }
                
                let randomDay = Int.random(in: 1...28) // L·∫•y ng√†y ng·∫´u nhi√™n trong th√°ng (an to√†n 28)
                guard let transactionDate = calendar.date(from: DateComponents(year: currentYear, month: currentMonth, day: randomDay)) else { continue }
                
                let amount = Double.random(in: 10_000...1_500_000) // Chi ti√™u ng·∫´u nhi√™n
                
                createTransaction(
                    context: context,
                    category: randomCategory,
                    date: transactionDate,
                    amount: amount,
                    // --- S·ª¨A ƒê·ªîI: D√πng key l√†m title (s·∫Ω ƒë∆∞·ª£c d·ªãch khi hi·ªÉn th·ªã) ---
                    title: sampleTitles.randomElement() ?? "common_expense", // L·∫•y title ng·∫´u nhi√™n t·ª´ key
                    // --- K·∫æT TH√öC S·ª¨A ƒê·ªîI ---
                    note: sampleNotes.randomElement() ?? "Chi ti√™u l·∫∑t v·∫∑t" // Gi·ªØ nguy√™n ho·∫∑c d√πng key
                )
            }

            // Di chuy·ªÉn ƒë·∫øn th√°ng ti·∫øp theo
            guard let nextMonth = calendar.date(byAdding: .month, value: 1, to: currentDate) else { break }
            currentDate = nextMonth
        }
        
        // 3. L∆∞u t·∫•t c·∫£ thay ƒë·ªïi v√†o Context
        do {
            try context.save()
            print("‚úÖ ƒê√£ seed th√†nh c√¥ng d·ªØ li·ªáu Transaction trong 3 nƒÉm.")
        } catch {
            print("‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu Transaction: \(error)")
            // X·ª≠ l√Ω l·ªói, c√≥ th·ªÉ rollback
            context.rollback()
        }
    }
    
    // --- H√†m tr·ª£ gi√∫p t·∫°o 1 Transaction (Gi·ªØ nguy√™n) ---
    private func createTransaction(context: NSManagedObjectContext, category: Category, date: Date, amount: Double, title: String, note: String?) {
        let newTransaction = Transaction(context: context)
        newTransaction.id = UUID()
        newTransaction.date = date
        newTransaction.createAt = date // Gi·∫£ l·∫≠p ng√†y t·∫°o
        newTransaction.updateAt = date // Gi·∫£ l·∫≠p ng√†y c·∫≠p nh·∫≠t
        newTransaction.type = category.type // QUAN TR·ªåNG: ƒê·ªìng b·ªô type
        newTransaction.amount = amount
        newTransaction.title = title // L∆∞u KEY v√†o ƒë√¢y
        newTransaction.note = note
        newTransaction.category = category // QUAN TR·ªåNG: Li√™n k·∫øt v·ªõi Category
    }
}
