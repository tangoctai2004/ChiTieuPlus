import SwiftUI
import CoreData

struct ContentView: View {
    @Environment(\.managedObjectContext) private var context

    // --- Dá»¯ liá»‡u máº«u cho Category (Giá»¯ nguyÃªn) ---
    let defaultExpenses: [(name: String, iconName: String)] = [
        ("Ä‚n uá»‘ng", "fork.knife"),
        ("Chi tiÃªu hÃ ng ngÃ y", "cart.fill"),
        ("Quáº§n Ã¡o", "tshirt.fill"),
        ("Má»¹ pháº©m", "hand.raised.fingers.spread.fill"),
        ("PhÃ­ tiá»‡c tÃ¹ng", "party.popper.fill"),
        ("Y táº¿", "pills.fill"),
        ("GiÃ¡o dá»¥c", "graduationcap.fill"),
        ("Tiá»n Ä‘iá»‡n", "bolt.fill"),
        ("Äi láº¡i", "bus.fill"),
        ("PhÃ­ liÃªn láº¡c", "phone.fill"),
        ("Tiá»n nhÃ ", "house.fill")
    ]
    
    let defaultIncomes: [(name: String, iconName: String)] = [
        ("Tiá»n lÆ°Æ¡ng", "banknote.fill"),
        ("Tiá»n phá»¥ cáº¥p", "person.3.fill"),
        ("Tiá»n thÆ°á»Ÿng", "dollarsign.circle.fill"),
        ("Thu nháº­p phá»¥", "lightbulb.fill"),
        ("Äáº§u tÆ°", "chart.line.uptrend.xyaxis"),
        ("Thu nháº­p táº¡m thá»i", "briefcase.fill")
    ]
    
    // --- HÃ m táº¡o Category máº«u (Giá»¯ nguyÃªn) ---
    func seedDefaultCategoriesIfNeeded(context: NSManagedObjectContext) {
        let fetchRequest: NSFetchRequest<Category> = Category.fetchRequest()
        
        do {
            let existingCount = try context.count(for: fetchRequest)
            guard existingCount == 0 else {
                print("âœ… Dá»¯ liá»‡u Category Ä‘Ã£ tá»“n táº¡i, khÃ´ng cáº§n seed.")
                return
            }
        } catch {
            print("âŒ Lá»—i khi kiá»ƒm tra Category: \(error)")
            return
        }

        for categoryInfo in defaultExpenses {
            let cat = Category(context: context)
            cat.id = UUID()
            cat.name = categoryInfo.name
            cat.type = "expense" // Loáº¡i chi tiÃªu
            cat.iconName = categoryInfo.iconName
            cat.createAt = Date()
            cat.updateAt = Date()
        }

        for categoryInfo in defaultIncomes {
            let cat = Category(context: context)
            cat.id = UUID()
            cat.name = categoryInfo.name
            cat.type = "income" // Loáº¡i thu nháº­p
            cat.iconName = categoryInfo.iconName
            cat.createAt = Date()
            cat.updateAt = Date()
        }

        do {
            try context.save()
            print("âœ… ÄÃ£ seed thÃ nh cÃ´ng cÃ¡c category máº·c Ä‘á»‹nh.")
        } catch {
            print("âŒ Lá»—i khi lÆ°u cÃ¡c category máº·c Ä‘á»‹nh: \(error)")
        }
    }

    // --- HÃ€M Má»šI: Táº¡o dá»¯ liá»‡u giao dá»‹ch máº«u trong 3 nÄƒm ---
    func seedSampleTransactionsIfNeeded(context: NSManagedObjectContext) {
        let transactionFetchRequest: NSFetchRequest<Transaction> = Transaction.fetchRequest()
        
        do {
            let existingCount = try context.count(for: transactionFetchRequest)
            guard existingCount == 0 else {
                print("âœ… Dá»¯ liá»‡u Transaction Ä‘Ã£ tá»“n táº¡i, khÃ´ng cáº§n seed.")
                return
            }
        } catch {
            print("âŒ Lá»—i khi kiá»ƒm tra Transaction: \(error)")
            return
        }

        // 1. Láº¥y táº¥t cáº£ cÃ¡c Category Ä‘Ã£ táº¡o
        let categoryFetchRequest: NSFetchRequest<Category> = Category.fetchRequest()
        guard let allCategories = try? context.fetch(categoryFetchRequest), !allCategories.isEmpty else {
            print("âŒ KhÃ´ng tÃ¬m tháº¥y Category Ä‘á»ƒ táº¡o Transaction. HÃ£y Ä‘áº£m báº£o seed Category trÆ°á»›c.")
            return
        }
        
        let expenseCategories = allCategories.filter { $0.type == "expense" }
        let incomeCategories = allCategories.filter { $0.type == "income" }
        
        guard !expenseCategories.isEmpty, !incomeCategories.isEmpty else {
            print("âŒ Thiáº¿u danh má»¥c thu nháº­p hoáº·c chi tiÃªu.")
            return
        }

        let calendar = Calendar.current
        let endDate = Date() // NgÃ y hÃ´m nay
        guard let startDate = calendar.date(byAdding: .year, value: -3, to: endDate) else {
            print("âŒ KhÃ´ng thá»ƒ tÃ­nh toÃ¡n ngÃ y báº¯t Ä‘áº§u.")
            return
        }

        var currentDate = startDate
        let sampleNotes = ["CÃ  phÃª vá»›i báº¡n", "Ä‚n trÆ°a vÄƒn phÃ²ng", "Mua sáº¯m Shopee", "Thanh toÃ¡n hoÃ¡ Ä‘Æ¡n Ä‘iá»‡n", "Xem phim cuá»‘i tuáº§n", "Äá»• xÄƒng", "Äi siÃªu thá»‹"]

        print("ğŸ”„ Báº¯t Ä‘áº§u seed dá»¯ liá»‡u giao dá»‹ch 3 nÄƒm...")

        // 2. Láº·p qua tá»«ng thÃ¡ng trong 3 nÄƒm
        while currentDate <= endDate {
            let currentMonth = calendar.component(.month, from: currentDate)
            let currentYear = calendar.component(.year, from: currentDate)
            
            // --- Táº¡o 1-3 giao dá»‹ch THU NHáº¬P má»—i thÃ¡ng ---
            let incomeCount = Int.random(in: 1...3)
            for i in 0..<incomeCount {
                guard let randomCategory = incomeCategories.randomElement() else { continue }
                
                let randomDay = (randomCategory.name == "Tiá»n lÆ°Æ¡ng" && i == 0) ? 5 : Int.random(in: 1...28) // Giáº£ láº­p ngÃ y nháº­n lÆ°Æ¡ng
                guard let transactionDate = calendar.date(from: DateComponents(year: currentYear, month: currentMonth, day: randomDay)) else { continue }
                
                let amount: Double
                if randomCategory.name == "Tiá»n lÆ°Æ¡ng" && i == 0 {
                    amount = Double.random(in: 15_000_000...30_000_000) // LÆ°Æ¡ng cao hÆ¡n
                } else {
                    amount = Double.random(in: 500_000...3_000_000) // Thu nháº­p phá»¥
                }

                createTransaction(
                    context: context,
                    category: randomCategory,
                    date: transactionDate,
                    amount: amount,
                    title: randomCategory.name ?? "Thu nháº­p",
                    note: "Thu nháº­p thÃ¡ng \(currentMonth)"
                )
            }
            
            // --- Táº¡o 15-30 giao dá»‹ch CHI TIÃŠU má»—i thÃ¡ng ---
            let expenseCount = Int.random(in: 15...30)
            for _ in 0..<expenseCount {
                guard let randomCategory = expenseCategories.randomElement() else { continue }
                
                let randomDay = Int.random(in: 1...28) // Láº¥y ngÃ y ngáº«u nhiÃªn trong thÃ¡ng (an toÃ n 28)
                guard let transactionDate = calendar.date(from: DateComponents(year: currentYear, month: currentMonth, day: randomDay)) else { continue }
                
                let amount = Double.random(in: 10_000...1_500_000) // Chi tiÃªu ngáº«u nhiÃªn
                
                createTransaction(
                    context: context,
                    category: randomCategory,
                    date: transactionDate,
                    amount: amount,
                    title: randomCategory.name ?? "Chi tiÃªu",
                    note: sampleNotes.randomElement() ?? "Chi tiÃªu láº·t váº·t"
                )
            }

            // Di chuyá»ƒn Ä‘áº¿n thÃ¡ng tiáº¿p theo
            guard let nextMonth = calendar.date(byAdding: .month, value: 1, to: currentDate) else { break }
            currentDate = nextMonth
        }
        
        // 3. LÆ°u táº¥t cáº£ thay Ä‘á»•i vÃ o Context
        do {
            try context.save()
            print("âœ… ÄÃ£ seed thÃ nh cÃ´ng dá»¯ liá»‡u Transaction trong 3 nÄƒm.")
        } catch {
            print("âŒ Lá»—i khi lÆ°u dá»¯ liá»‡u Transaction: \(error)")
            // Xá»­ lÃ½ lá»—i, cÃ³ thá»ƒ rollback
            context.rollback()
        }
    }
    
    // --- HÃ m trá»£ giÃºp táº¡o 1 Transaction ---
    private func createTransaction(context: NSManagedObjectContext, category: Category, date: Date, amount: Double, title: String, note: String?) {
        let newTransaction = Transaction(context: context)
        newTransaction.id = UUID()
        newTransaction.date = date
        newTransaction.createAt = date // Giáº£ láº­p ngÃ y táº¡o
        newTransaction.updateAt = date // Giáº£ láº­p ngÃ y cáº­p nháº­t
        newTransaction.type = category.type // QUAN TRá»ŒNG: Äá»“ng bá»™ type
        newTransaction.amount = amount
        newTransaction.title = title
        newTransaction.note = note
        newTransaction.category = category // QUAN TRá»ŒNG: LiÃªn káº¿t vá»›i Category
    }

    // --- Giao diá»‡n View (Sá»­a Ä‘á»•i Ä‘á»ƒ gá»i cáº£ 2 hÃ m seed) ---
    var body: some View {
        Text("Äang táº¡o dá»¯ liá»‡u máº«u... Vui lÃ²ng kiá»ƒm tra Console (Debug Area) trong Xcode.")
            .padding()
            .multilineTextAlignment(.center)
            .onAppear {
                // Cháº¡y cÃ¡c hÃ m seed khi View xuáº¥t hiá»‡n
                // HÃ m nÃ y sáº½ tá»± kiá»ƒm tra Ä‘á»ƒ khÃ´ng cháº¡y láº¡i náº¿u dá»¯ liá»‡u Ä‘Ã£ tá»“n táº¡i
                
                // 1. Táº¡o Category trÆ°á»›c
                seedDefaultCategoriesIfNeeded(context: context)
                
                // 2. Táº¡o Transaction (sáº½ dÃ¹ng Category á»Ÿ bÆ°á»›c 1)
                seedSampleTransactionsIfNeeded(context: context)
            }
    }
}
