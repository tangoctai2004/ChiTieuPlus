import SwiftUI
import CoreData

struct ContentView: View {
    @Environment(\.managedObjectContext) private var context

    // Các tên danh mục mặc định theo phân loại Chi tiêu / Thu nhập
    let defaultExpenseCategories = [
        "Ăn uống",
        "Chi tiêu hàng ngày",
        "Quần áo",
        "Mỹ phẩm",
        "Phí tiệc tùng",
        "Y tế",
        "Giáo dục",
        "Tiền điện",
        "Đi lại",
        "Phí liên lạc",
        "Tiền nhà"
    ]
    let defaultIncomeCategories = [
        "Tiền lương",
        "Tiền phụ cấp",
        "Tiền thưởng",
        "Thu nhập phụ",
        "Đầu tư",
        "Thu nhập tạm thời"
    ]

    func seedDefaultCategoriesIfNeeded(context: NSManagedObjectContext) {
        // 1. Fetch các Category hiện có
        let fetch: NSFetchRequest<Category> = Category.fetchRequest()
        var existing: [Category] = []
        do {
            existing = try context.fetch(fetch)
        } catch {
            print("❌ Lỗi fetch Category: \(error)")
        }

        // 2. Map name -> Category để kiểm tra đã tồn tại
        var map: [String: Category] = [:]
        for cat in existing {
            if let name = cat.name {
                map[name] = cat
            }
        }

        // 3. Tạo các category expense nếu chưa có
        for name in defaultExpenseCategories {
            if map[name] == nil {
                let cat = Category(context: context)
                cat.id = UUID()
                cat.name = name
                cat.type = "expense"
                cat.createAt = Date()
                cat.updateAt = Date()
                map[name] = cat
            }
        }

        // 4. Tạo các category income nếu chưa có
        for name in defaultIncomeCategories {
            if map[name] == nil {
                let cat = Category(context: context)
                cat.id = UUID()
                cat.name = name
                cat.type = "income"
                cat.createAt = Date()
                cat.updateAt = Date()
                map[name] = cat
            }
        }

        // 5. Save nếu có thêm mới
        do {
            try context.save()
            print("✅ Đã seed các category mặc định")
        } catch {
            print("❌ Lỗi lưu các category mặc định: \(error)")
        }
    }

    var body: some View {
        Text("Hello")
            .onAppear {
                seedDefaultCategoriesIfNeeded(context: context)
            }
    }
}
